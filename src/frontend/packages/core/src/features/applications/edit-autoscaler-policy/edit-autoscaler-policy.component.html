<app-page-header>
  <h1>Edit AutoScaler Policy: {{ (applicationService.application$ | async)?.app.entity.name }} </h1>
  <div class="page-header-right">
    <button mat-icon-button mat-button routerLink="{{parentUrl}}">
      <mat-icon>clear</mat-icon>
    </button>
  </div>
</app-page-header>
<app-steppers cancel="{{parentUrl}}" *ngIf="appAutoscalerPolicy$ | async as policy">
  <app-step [title]="'Default Instance Limits'" [onNext]="finishLimit" [valid]="editLimitForm.valid">
    <form [formGroup]="editLimitForm" validate class="stepper-form edit-app">
      <mat-form-field>
        <input matInput placeholder="Minimum Instance Count" formControlName="instance_min_count" type="number"
          required>
        <mat-error *ngIf="editLimitForm.get('instance_min_count').hasError('alert_invalid_policy_minimum_range')">
          {{alert_invalid_policy_minimum_range}}
        </mat-error>
      </mat-form-field>
      <mat-form-field style="margin-top: 0.5em">
        <input matInput placeholder="Maximum Instance Count" formControlName="instance_max_count" type="number"
          required>
        <mat-error *ngIf="editLimitForm.get('instance_max_count').hasError('alert_invalid_policy_maximum_range')">
          {{alert_invalid_policy_maximum_range}}
        </mat-error>
      </mat-form-field>
    </form>
  </app-step>
  <app-step [title]="'Scaling Rules'" [disablePrevious]="editingIndex!=-1" [showAdd]="true"
    [disableAdd]="editingIndex!=-1" [onAdd]="addTrigger" [onNext]="finishTrigger"
    [valid]="editTriggerForm.valid || editingIndex==-1">
    <app-tile-grid>
      <app-tile-group *ngFor="let rule of policy && policy.scaling_rules_form; let index = index">
        <app-tile>
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                Rule {{index+1}}:
              </mat-card-title>
            </mat-card-header>
            <mat-card-content class="app-autoscaler-edit-policy-item">
              <div *ngIf="editingIndex!=index" class="app-autoscaler-edit-policy-desc">
                If average {{rule.metric_type}} {{rule.operator}} {{rule.threshold}} for {{rule.breach_duration_secs}}
                seconds, then {{rule.adjustment}} instances. Cooldown: {{rule.cool_down_secs}} seconds.
              </div>
              <div *ngIf="editingIndex==index">
                <form [formGroup]="editTriggerForm" validate>
                  If average
                  <mat-form-field *ngIf="metricTypes.length > 1">
                    <mat-select class="reset-margin" placeholder="Metric Type" formControlName="metric_type" required>
                      <mat-option *ngFor="let metricType of metricTypes" [value]="metricType">
                        {{ metricType }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field *ngIf="metricTypes.length > 1">
                    <mat-select class="reset-margin" placeholder="Operator" formControlName="operator" required>
                      <mat-option *ngFor="let operator of operatorTypes" [value]="operator">
                        {{ operator }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field>
                    <input matInput placeholder="Threshold" type="number" formControlName="threshold" required>
                  </mat-form-field>
                  for
                  <mat-form-field>
                    <input matInput placeholder="Breach Duration" type="number" formControlName="breach_duration_secs">
                  </mat-form-field>
                  seconsds, then {{rule.operator=='>'||rule.operator=='>='?'add':'remove'}}
                  <mat-form-field>
                    <input matInput placeholder="Adjustment" type="number" formControlName="adjustment" required>
                  </mat-form-field>
                  <mat-form-field *ngIf="metricTypes.length > 1">
                    <mat-select class="reset-margin" placeholder="Adjustment Type" formControlName="adjustment_type"
                      required>
                      <mat-option [value]="'value'">instances</mat-option>
                      <mat-option [value]="'percentage'">% instances</mat-option>
                    </mat-select>
                  </mat-form-field>
                  . Cooldown:
                  <mat-form-field>
                    <input matInput placeholder="Cooldown" type="number" formControlName="cool_down_secs">
                  </mat-form-field>
                  seconds.
                </form>
                <mat-error *ngIf="editTriggerForm.get('threshold').hasError('required')">
                  Threshold is required
                </mat-error>
                <mat-error
                  *ngIf="editTriggerForm.get('threshold').hasError('alert_invalid_policy_trigger_threshold_100')">
                  {{alert_invalid_policy_trigger_threshold_100}}
                </mat-error>
                <mat-error
                  *ngIf="editTriggerForm.get('threshold').hasError('alert_invalid_policy_trigger_threshold_range')">
                  <span *ngIf="editingScaleType=='upper'">
                    {{alert_invalid_policy_trigger_upper_threshold_range}}
                  </span>
                  <span *ngIf="editingScaleType!='upper'">
                    {{alert_invalid_policy_trigger_lower_threshold_range}}
                  </span>
                </mat-error>
                <mat-error
                  *ngIf="editTriggerForm.get('breach_duration_secs').hasError('min') || editTriggerForm.get('breach_duration_secs').hasError('max')">
                  {{alert_invalid_policy_trigger_breachduration_range}}
                </mat-error>
                <mat-error *ngIf="editTriggerForm.get('adjustment').hasError('required')">
                  Adjustment is required
                </mat-error>
                <mat-error
                  *ngIf="editTriggerForm.get('adjustment').hasError('alert_invalid_policy_trigger_step_range')">
                  <span *ngIf="editingAdjustmentType=='value'">
                    {{alert_invalid_policy_trigger_step_range}}
                  </span>
                  <span *ngIf="editingAdjustmentType!='value'">
                    {{alert_invalid_policy_trigger_step_percentage_range}}
                  </span>
                </mat-error>
                <mat-error
                  *ngIf="editTriggerForm.get('cool_down_secs').hasError('min') || editTriggerForm.get('cool_down_secs').hasError('max')">
                  {{alert_invalid_policy_trigger_cooldown_range}}
                </mat-error>
              </div>
            </mat-card-content>
            <mat-card-actions class="app-auto-scaler__actions">
              <button *ngIf="editingIndex!=index" (click)="editTrigger(index)" mat-icon-button>
                <mat-icon>edit</mat-icon>
              </button>
              <button *ngIf="editingIndex==index" (click)="finishTrigger()" [disabled]="editTriggerForm.invalid"
                mat-icon-button>
                <mat-icon>done</mat-icon>
              </button>
              <button (click)="removeTrigger(index)" mat-icon-button>
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </app-tile>
      </app-tile-group>
    </app-tile-grid>
  </app-step>
  <app-step [title]="'Recurring Schedules'" [disablePrevious]="editingIndex!=-1" [showAdd]="true"
    [disableAdd]="editingIndex!=-1" [onAdd]="addRecurringSchedule" [onNext]="resetEditingIndex">
    <app-tile-grid>
      <app-tile-group *ngFor="let rule of policy && policy.schedules.recurring_schedule; let index = index">
        <app-tile>
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                Schedule {{index+1}}:
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="editingIndex!=index">
                <span *ngIf="rule.initial_min_instance_count">The initial number of application instance is
                  {{rule.initial_min_instance_count}}, and the range </span>
                <span *ngIf="!rule.initial_min_instance_count">The number of application instance </span>
                <span>is limited to from {{rule.instance_min_count}} to {{rule.instance_max_count}} during
                  {{rule.start_time}} ~ {{rule.end_time}} every </span>
                <span *ngIf="rule.days_of_month">{{rule.days_of_month}} of the month</span>
                <span *ngIf="rule.days_of_week">{{rule.days_of_week}} of the week</span>
                <span *ngIf="rule.start_date">, effective from {{rule.start_date}} to {{rule.end_date}}.</span>
                <span *ngIf="!rule.start_date">.</span>
              </div>
              <div *ngIf="editingIndex==index">
                <form [formGroup]="editRecurringScheduleForm" validate class="edit-recurring-schedule">
                  <div class="app-metadata">
                    <div class="app-metadata__two-cols">
                      <app-metadata-item label="Effective Duration">
                        <mat-radio-group formControlName="effective_type">
                          <mat-radio-button value="always" (click)="resetEffectiveType('always')">Always
                          </mat-radio-button>
                          <mat-radio-button value="custom" (click)="resetEffectiveType('custom')"
                            style="margin-left: 0.5em">
                            <mat-form-field class="autoscaler-date-input" style="width:50%">
                              <input matInput placeholder="From" type="date" formControlName="start_date" required>
                            </mat-form-field>
                            <mat-form-field class="autoscaler-date-input" style="width:50%">
                              <input matInput placeholder="To" type="date" formControlName="end_date" required>
                            </mat-form-field>
                          </mat-radio-button>
                        </mat-radio-group>
                      </app-metadata-item>
                      <app-metadata-item label="Repeat By">
                        <mat-radio-group formControlName="repeat_type">
                          <mat-radio-button value="week" (click)="resetRepeatType('week')">
                            Week
                          </mat-radio-button>
                          <mat-radio-button value="month" (click)="resetRepeatType('month')" style="margin-left: 0.5em">
                            Month
                          </mat-radio-button>
                        </mat-radio-group>
                      </app-metadata-item>
                      <mat-form-field>
                        <mat-select *ngIf="editingRepeatType=='week'" placeholder="Repeat On" multiple
                          formControlName="days_of_week" required>
                          <mat-option *ngFor="let day of weekdayOptions; let dayIndex = index" [value]="dayIndex">
                            {{day}}
                          </mat-option>
                        </mat-select>
                        <mat-select *ngIf="editingRepeatType=='month'" placeholder="Repeat On" multiple
                          formControlName="days_of_month" required>
                          <mat-option *ngFor="let day of monthdayOptions; let dayIndex = index" [value]="dayIndex">
                            {{day}}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                    <div class="app-metadata__two-cols">
                      <app-metadata-item label="Repeat Time">
                        <mat-form-field>
                          <input matInput placeholder="Start" type="time" formControlName="start_time" required>
                        </mat-form-field>
                        <mat-form-field style="margin-left: 0.5em">
                          <input matInput placeholder="End" type="time" formControlName="end_time" required>
                        </mat-form-field>
                      </app-metadata-item>
                      <app-metadata-item label="Instance Count">
                        <mat-form-field style="width:30%; ">
                          <input matInput placeholder="Minimum" type="number" formControlName="instance_min_count"
                            required>
                        </mat-form-field>
                        <mat-form-field style="width:30%; margin-left: 0.5em">
                          <input matInput placeholder="Initial Minimum" type="number"
                            formControlName="initial_min_instance_count">
                        </mat-form-field>
                        <mat-form-field style="width:30%; margin-left: 0.5em">
                          <input matInput placeholder="Maximum" type="number" formControlName="instance_max_count"
                            required>
                        </mat-form-field>
                      </app-metadata-item>
                    </div>
                  </div>
                </form>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('instance_min_count').hasError('alert_invalid_policy_minimum_range')">
                  {{alert_invalid_policy_minimum_range}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('instance_max_count').hasError('alert_invalid_policy_maximum_range')">
                  {{alert_invalid_policy_maximum_range}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('initial_min_instance_count').hasError('alert_invalid_policy_initial_minimum_range')">
                  {{alert_invalid_policy_initial_minimum_range}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('start_date').hasError('alert_invalid_policy_schedule_start_date_before_now')">
                  {{alert_invalid_policy_schedule_start_date_before_now}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('start_date').hasError('alert_invalid_policy_schedule_end_date_before_start_date')">
                  {{alert_invalid_policy_schedule_end_date_before_start_date}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('end_date').hasError('alert_invalid_policy_schedule_end_date_before_now')">
                  {{alert_invalid_policy_schedule_end_date_before_now}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('end_date').hasError('alert_invalid_policy_schedule_end_date_before_start_date')">
                  {{alert_invalid_policy_schedule_end_date_before_start_date}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('start_time').hasError('alert_invalid_policy_schedule_end_time_before_start_time')">
                  {{alert_invalid_policy_schedule_end_time_before_start_time}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('end_time').hasError('alert_invalid_policy_schedule_end_time_before_start_time')">
                  {{alert_invalid_policy_schedule_end_time_before_start_time}}
                </mat-error>
                <mat-error *ngIf="editingRepeatType=='week' && editRecurringScheduleForm.get('days_of_week').hasError('required')">
                  {{alert_invalid_policy_schedule_repeat_on}}
                </mat-error>
                <mat-error
                  *ngIf="editingRepeatType=='week' && editRecurringScheduleForm.get('days_of_week').hasError('alert_invalid_policy_schedule_recurring_conflict')">
                  days_of_week {{alert_invalid_policy_schedule_recurring_conflict}}
                </mat-error>
                <mat-error *ngIf="editingRepeatType=='month' && editRecurringScheduleForm.get('days_of_month').hasError('required')">
                  {{alert_invalid_policy_schedule_repeat_on}}
                </mat-error>
                <mat-error
                  *ngIf="editingRepeatType=='month' && editRecurringScheduleForm.get('days_of_month').hasError('alert_invalid_policy_schedule_recurring_conflict')">
                  days_of_month {{alert_invalid_policy_schedule_recurring_conflict}}
                </mat-error>
              </div>
            </mat-card-content>
            <mat-card-actions class="app-auto-scaler__actions">
              <button *ngIf="editingIndex!=index" (click)="editRecurringSchedule(index)" mat-icon-button>
                <mat-icon>edit</mat-icon>
              </button>
              <button *ngIf="editingIndex==index" (click)="finishRecurringSchedule(index)" mat-icon-button>
                <mat-icon>done</mat-icon>
              </button>
              <button (click)="removeRecurringSchedule(index)" mat-icon-button>
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </app-tile>
      </app-tile-group>
    </app-tile-grid>
  </app-step>
  <app-step [title]="'Specific Dates'" [disablePrevious]="editingIndex!=-1" [showAdd]="true"
    [disableAdd]="editingIndex!=-1" [onAdd]="addSpecificDate" [onNext]="updatePolicy">
    <app-tile-grid>
      <app-tile-group *ngFor="let rule of policy && policy.schedules.specific_date; let index = index">
        <app-tile>
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                Schedule {{index+1}}:
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="editingIndex!=index">
                <span *ngIf="rule.initial_min_instance_count">The initial number of application instance is
                  {{rule.initial_min_instance_count}}, and the range </span>
                <span *ngIf="!rule.initial_min_instance_count">The number of application instance </span>
                <span>is limited to from {{rule.instance_min_count}} to {{rule.instance_max_count}} from
                  {{rule.start_date_time}} to {{rule.end_date_time}}.</span>
              </div>
              <div *ngIf="editingIndex==index">
                <form [formGroup]="editSpecificDateForm" validate class="edit-recurring-schedule">
                  <div class="app-metadata">
                    <div class="app-metadata__two-cols">
                      <app-metadata-item label="Effective Date Time" class="app-autoscaler-edit-specific-date">
                        <mat-form-field>
                          <input matInput placeholder="Start" type="datetime-local" formControlName="start_date_time"
                            required>
                        </mat-form-field>
                        <mat-form-field style="margin-left: 0.5em">
                          <input matInput placeholder="End" type="datetime-local" formControlName="end_date_time"
                            required>
                        </mat-form-field>
                      </app-metadata-item>
                    </div>
                    <div class="app-metadata__two-cols">
                      <app-metadata-item label="Instance Count">
                        <mat-form-field style="width:30%; ">
                          <input matInput placeholder="Minimum" type="number" formControlName="instance_min_count"
                            required>
                        </mat-form-field>
                        <mat-form-field style="width:30%; margin-left: 0.5em">
                          <input matInput placeholder="Initial Minimum" type="number"
                            formControlName="initial_min_instance_count">
                        </mat-form-field>
                        <mat-form-field style="width:30%; margin-left: 0.5em">
                          <input matInput placeholder="Maximum" type="number" formControlName="instance_max_count"
                            required>
                        </mat-form-field>
                      </app-metadata-item>
                    </div>
                  </div>
                </form>
              </div>
            </mat-card-content>
            <mat-card-actions class="app-auto-scaler__actions">
              <button *ngIf="editingIndex!=index" (click)="editSpecificDate(index)" mat-icon-button>
                <mat-icon>edit</mat-icon>
              </button>
              <button *ngIf="editingIndex==index" (click)="finishSpecificDate(index)" mat-icon-button>
                <mat-icon>done</mat-icon>
              </button>
              <button (click)="removeSpecificDate(index)" mat-icon-button>
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </app-tile>
      </app-tile-group>
    </app-tile-grid>
  </app-step>
</app-steppers>