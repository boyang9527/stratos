<app-page-header>
  <h1>Edit AutoScaler Policy: {{ (applicationService.application$ | async)?.app.entity.name }} </h1>
  <div class="page-header-right">
    <button mat-icon-button mat-button routerLink="{{parentUrl}}">
      <mat-icon>clear</mat-icon>
    </button>
  </div>
</app-page-header>
<app-steppers cancel="{{parentUrl}}" *ngIf="appAutoscalerPolicy$ | async as policy">
  <app-step [title]="'Default Instance Limits'" [onNext]="finishLimit" [valid]="editLimitForm.valid">
    <form [formGroup]="editLimitForm" validate class="stepper-form edit-app">
      <mat-form-field>
        <input matInput placeholder="Minimum Instance Count" formControlName="instance_min_count" type="number"
          required>
        <mat-error *ngIf="editLimitForm.get('instance_min_count').hasError('alertInvalidPolicyMinimumRange')">
          {{alertInvalidPolicyMinimumRange}}
        </mat-error>
      </mat-form-field>
      <mat-form-field style="margin-top: 0.5em">
        <input matInput placeholder="Maximum Instance Count" formControlName="instance_max_count" type="number"
          required>
        <mat-error *ngIf="editLimitForm.get('instance_max_count').hasError('alertInvalidPolicyMaximumRange')">
          {{alertInvalidPolicyMaximumRange}}
        </mat-error>
      </mat-form-field>
    </form>
  </app-step>
  <app-step [title]="'Scaling Rules'" [disablePrevious]="editIndex!=-1" [showAdd]="true"
    [disableAdd]="editIndex!=-1" [onAdd]="addTrigger"
    [valid]="editIndex==-1 && policy.scaling_rules_form && policy.scaling_rules_form.length > 0">
    <app-tile-grid>
      <app-tile-group *ngFor="let rule of policy && policy.scaling_rules_form; let index = index">
        <app-tile>
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                Rule {{index+1}}:
              </mat-card-title>
            </mat-card-header>
            <mat-card-content class="app-autoscaler-edit-policy-item">
              <div *ngIf="editIndex!=index" class="app-autoscaler-edit-policy-desc">
                If average {{rule.metric_type}} {{rule.operator}} {{rule.threshold}} for {{rule.breach_duration_secs}}
                seconds, then {{rule.adjustment}} instances. Cooldown: {{rule.cool_down_secs}} seconds.
              </div>
              <div *ngIf="editIndex==index">
                <form [formGroup]="editTriggerForm" validate>
                  If average
                  <mat-form-field *ngIf="metricTypes.length > 1">
                    <mat-select class="reset-margin" placeholder="Metric Type" formControlName="metric_type" required>
                      <mat-option *ngFor="let metricType of metricTypes" [value]="metricType">
                        {{ metricType }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field *ngIf="metricTypes.length > 1">
                    <mat-select class="reset-margin" placeholder="Operator" formControlName="operator" required>
                      <mat-option *ngFor="let operator of operatorTypes" [value]="operator">
                        {{ operator }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                  <mat-form-field>
                    <input matInput placeholder="Threshold" type="number" formControlName="threshold" required>
                  </mat-form-field>
                  for
                  <mat-form-field>
                    <input matInput placeholder="Breach Duration" type="number" formControlName="breach_duration_secs">
                  </mat-form-field>
                  seconsds, then {{rule.operator=='>'||rule.operator=='>='?'add':'remove'}}
                  <mat-form-field>
                    <input matInput placeholder="Adjustment" type="number" formControlName="adjustment" required>
                  </mat-form-field>
                  <mat-form-field *ngIf="metricTypes.length > 1">
                    <mat-select class="reset-margin" placeholder="Adjustment Type" formControlName="adjustment_type"
                      required>
                      <mat-option [value]="'value'">instances</mat-option>
                      <mat-option [value]="'percentage'">% instances</mat-option>
                    </mat-select>
                  </mat-form-field>
                  . Cooldown:
                  <mat-form-field>
                    <input matInput placeholder="Cooldown" type="number" formControlName="cool_down_secs">
                  </mat-form-field>
                  seconds.
                </form>
                <mat-error *ngIf="editTriggerForm.get('threshold').hasError('required')">
                  Threshold is required
                </mat-error>
                <mat-error
                  *ngIf="editTriggerForm.get('threshold').hasError('alertInvalidPolicyTriggerThreshold100')">
                  {{alertInvalidPolicyTriggerThreshold100}}
                </mat-error>
                <mat-error
                  *ngIf="editTriggerForm.get('threshold').hasError('alertInvalidPolicyTriggerThresholdRange')">
                  <span *ngIf="editScaleType=='upper'">
                    {{alertInvalidPolicyTriggerUpperThresholdRange}}
                  </span>
                  <span *ngIf="editScaleType!='upper'">
                    {{alertInvalidPolicyTriggerLowerThresholdRange}}
                  </span>
                </mat-error>
                <mat-error
                  *ngIf="editTriggerForm.get('breach_duration_secs').hasError('min') || editTriggerForm.get('breach_duration_secs').hasError('max')">
                  {{alertInvalidPolicyTriggerBreachDurationRange}}
                </mat-error>
                <mat-error *ngIf="editTriggerForm.get('adjustment').hasError('required')">
                  Adjustment is required
                </mat-error>
                <mat-error
                  *ngIf="editTriggerForm.get('adjustment').hasError('alertInvalidPolicyTriggerStepRange')">
                  <span *ngIf="editAdjustmentType=='value'">
                    {{alertInvalidPolicyTriggerStepRange}}
                  </span>
                  <span *ngIf="editAdjustmentType!='value'">
                    {{alertInvalidPolicyTriggerStepPercentageRange}}
                  </span>
                </mat-error>
                <mat-error
                  *ngIf="editTriggerForm.get('cool_down_secs').hasError('min') || editTriggerForm.get('cool_down_secs').hasError('max')">
                  {{alertInvalidPolicyTriggerCooldownRange}}
                </mat-error>
              </div>
            </mat-card-content>
            <mat-card-actions class="app-auto-scaler__actions">
              <button *ngIf="editIndex!=index" (click)="editTrigger(index)" [disabled]="editIndex!=-1"
                mat-icon-button>
                <mat-icon>edit</mat-icon>
              </button>
              <button *ngIf="editIndex==index" (click)="finishTrigger()" [disabled]="editTriggerForm.invalid"
                mat-icon-button>
                <mat-icon>done</mat-icon>
              </button>
              <button (click)="removeTrigger(index)" mat-icon-button>
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </app-tile>
      </app-tile-group>
    </app-tile-grid>
  </app-step>
  <app-step [title]="'Recurring Schedules'" [disablePrevious]="editIndex!=-1" [showAdd]="true"
    [disableAdd]="editIndex!=-1" [onAdd]="addRecurringSchedule" [valid]="editIndex==-1">
    <app-tile-grid>
      <app-tile-group *ngFor="let rule of policy && policy.schedules.recurring_schedule; let index = index">
        <app-tile>
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                Schedule {{index+1}}:
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="editIndex!=index">
                <span *ngIf="rule.initial_min_instance_count">The initial number of application instance is
                  {{rule.initial_min_instance_count}}, and the range </span>
                <span *ngIf="!rule.initial_min_instance_count">The number of application instance </span>
                <span>is limited to from {{rule.instance_min_count}} to {{rule.instance_max_count}} during
                  {{rule.start_time}} ~ {{rule.end_time}} every </span>
                <span *ngIf="rule.days_of_month">{{rule.days_of_month}} of the month</span>
                <span *ngIf="rule.days_of_week">{{rule.days_of_week}} of the week</span>
                <span *ngIf="rule.start_date">, effective from {{rule.start_date}} to {{rule.end_date}}.</span>
                <span *ngIf="!rule.start_date">.</span>
              </div>
              <div *ngIf="editIndex==index">
                <form [formGroup]="editRecurringScheduleForm" validate class="edit-recurring-schedule">
                  <div class="app-metadata">
                    <div class="app-metadata__two-cols">
                      <app-metadata-item label="Effective Duration">
                        <mat-radio-group formControlName="effective_type">
                          <mat-radio-button value="always" (click)="resetEffectiveType('always')"
                            style="margin-right: 0.5em">Always
                          </mat-radio-button>
                          <mat-radio-button value="custom" (click)="resetEffectiveType('custom')">
                            <span *ngIf="editEffectiveType=='always'">
                              Custom
                            </span>
                            <mat-form-field *ngIf="editEffectiveType=='custom'" class="autoscaler-date-input"
                              style="width:50%">
                              <input matInput placeholder="From" type="date" formControlName="start_date" required>
                            </mat-form-field>
                            <mat-form-field *ngIf="editEffectiveType=='custom'" class="autoscaler-date-input"
                              style="width:50%">
                              <input matInput placeholder="To" type="date" formControlName="end_date" required>
                            </mat-form-field>
                          </mat-radio-button>
                        </mat-radio-group>
                      </app-metadata-item>
                      <app-metadata-item label="Repeat By">
                        <mat-radio-group formControlName="repeat_type">
                          <mat-radio-button value="week" (click)="resetRepeatType('week')" style="margin-right: 0.5em">
                            Week
                          </mat-radio-button>
                          <mat-radio-button value="month" (click)="resetRepeatType('month')">
                            Month
                          </mat-radio-button>
                        </mat-radio-group>
                      </app-metadata-item>
                      <mat-form-field>
                        <mat-select *ngIf="editRepeatType=='week'" placeholder="Repeat On" multiple
                          formControlName="days_of_week" required>
                          <mat-option *ngFor="let day of weekdayOptions; let dayIndex = index" [value]="dayIndex">
                            {{day}}
                          </mat-option>
                        </mat-select>
                        <mat-select *ngIf="editRepeatType=='month'" placeholder="Repeat On" multiple
                          formControlName="days_of_month" required>
                          <mat-option *ngFor="let day of monthdayOptions; let dayIndex = index" [value]="dayIndex">
                            {{day}}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                    <div class="app-metadata__two-cols">
                      <app-metadata-item label="Repeat Time">
                        <mat-form-field>
                          <input matInput placeholder="Start" type="time" formControlName="start_time" required>
                        </mat-form-field>
                        <mat-form-field style="margin-left: 0.5em">
                          <input matInput placeholder="End" type="time" formControlName="end_time" required>
                        </mat-form-field>
                      </app-metadata-item>
                      <app-metadata-item label="Instance Count">
                        <mat-form-field style="width:30%; ">
                          <input matInput placeholder="Minimum" type="number" formControlName="instance_min_count"
                            required>
                        </mat-form-field>
                        <mat-form-field style="width:30%; margin-left: 0.5em">
                          <input matInput placeholder="Initial Minimum" type="number"
                            formControlName="initial_min_instance_count">
                        </mat-form-field>
                        <mat-form-field style="width:30%; margin-left: 0.5em">
                          <input matInput placeholder="Maximum" type="number" formControlName="instance_max_count"
                            required>
                        </mat-form-field>
                      </app-metadata-item>
                    </div>
                  </div>
                </form>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('instance_min_count').hasError('alertInvalidPolicyMinimumRange')">
                  {{alertInvalidPolicyMinimumRange}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('instance_max_count').hasError('alertInvalidPolicyMaximumRange')">
                  {{alertInvalidPolicyMaximumRange}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('initial_min_instance_count').hasError('alertInvalidPolicyInitialMaximumRange')">
                  {{alertInvalidPolicyInitialMaximumRange}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('start_date').hasError('alertInvalidPolicyScheduleStartDateBeforeNow')">
                  {{alertInvalidPolicyScheduleStartDateBeforeNow}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('start_date').hasError('alertInvalidPolicyScheduleEndDateBeforeStartDate')">
                  {{alertInvalidPolicyScheduleEndDateBeforeStartDate}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('end_date').hasError('alertInvalidPolicyScheduleEndDateBeforeNow')">
                  {{alertInvalidPolicyScheduleEndDateBeforeNow}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('end_date').hasError('alertInvalidPolicyScheduleEndDateBeforeStartDate')">
                  {{alertInvalidPolicyScheduleEndDateBeforeStartDate}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('start_time').hasError('alertInvalidPolicyScheduleEndTimeBeforeStartTime')">
                  {{alertInvalidPolicyScheduleEndTimeBeforeStartTime}}
                </mat-error>
                <mat-error
                  *ngIf="editRecurringScheduleForm.get('end_time').hasError('alertInvalidPolicyScheduleEndTimeBeforeStartTime')">
                  {{alertInvalidPolicyScheduleEndTimeBeforeStartTime}}
                </mat-error>
                <mat-error
                  *ngIf="editRepeatType=='week' && editRecurringScheduleForm.get('days_of_week').hasError('required')">
                  {{alertInvalidPolicyScheduleRepeatOn}}
                </mat-error>
                <mat-error
                  *ngIf="editRepeatType=='week' && editRecurringScheduleForm.get('days_of_week').hasError('alertInvalidPolicyScheduleRecurringConflict')">
                  days_of_week {{alertInvalidPolicyScheduleRecurringConflict}}
                </mat-error>
                <mat-error
                  *ngIf="editRepeatType=='month' && editRecurringScheduleForm.get('days_of_month').hasError('required')">
                  {{alertInvalidPolicyScheduleRepeatOn}}
                </mat-error>
                <mat-error
                  *ngIf="editRepeatType=='month' && editRecurringScheduleForm.get('days_of_month').hasError('alertInvalidPolicyScheduleRecurringConflict')">
                  days_of_month {{alertInvalidPolicyScheduleRecurringConflict}}
                </mat-error>
              </div>
            </mat-card-content>
            <mat-card-actions class="app-auto-scaler__actions">
              <button *ngIf="editIndex!=index" (click)="editRecurringSchedule(index)" [disabled]="editIndex!=-1"
                mat-icon-button>
                <mat-icon>edit</mat-icon>
              </button>
              <button *ngIf="editIndex==index" (click)="finishRecurringSchedule()"
                [disabled]="editRecurringScheduleForm.invalid" mat-icon-button>
                <mat-icon>done</mat-icon>
              </button>
              <button (click)="removeRecurringSchedule(index)" mat-icon-button>
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </app-tile>
      </app-tile-group>
    </app-tile-grid>
  </app-step>
  <app-step [title]="'Specific Dates'" [disablePrevious]="editIndex!=-1" [showAdd]="true"
    [disableAdd]="editIndex!=-1" [onAdd]="addSpecificDate" [onNext]="updatePolicy" [valid]="editIndex==-1">
    <app-tile-grid>
      <app-tile-group *ngFor="let rule of policy && policy.schedules.specific_date; let index = index">
        <app-tile>
          <mat-card>
            <mat-card-header>
              <mat-card-title>
                Schedule {{index+1}}:
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="editIndex!=index">
                <span *ngIf="rule.initial_min_instance_count">The initial number of application instance is
                  {{rule.initial_min_instance_count}}, and the range </span>
                <span *ngIf="!rule.initial_min_instance_count">The number of application instance </span>
                <span>is limited to from {{rule.instance_min_count}} to {{rule.instance_max_count}} from
                  {{rule.start_date_time}} to {{rule.end_date_time}}.</span>
              </div>
              <div *ngIf="editIndex==index">
                <form [formGroup]="editSpecificDateForm" validate class="edit-recurring-schedule">
                  <div class="app-metadata">
                    <div class="app-metadata__two-cols">
                      <app-metadata-item label="Effective Date Time" class="app-autoscaler-edit-specific-date">
                        <mat-form-field>
                          <input matInput placeholder="Start" type="datetime-local" formControlName="start_date_time"
                            required>
                        </mat-form-field>
                        <mat-form-field style="margin-left: 0.5em">
                          <input matInput placeholder="End" type="datetime-local" formControlName="end_date_time"
                            required>
                        </mat-form-field>
                      </app-metadata-item>
                    </div>
                    <div class="app-metadata__two-cols">
                      <app-metadata-item label="Instance Count">
                        <mat-form-field style="width:30%; ">
                          <input matInput placeholder="Minimum" type="number" formControlName="instance_min_count"
                            required>
                        </mat-form-field>
                        <mat-form-field style="width:30%; margin-left: 0.5em">
                          <input matInput placeholder="Initial Minimum" type="number"
                            formControlName="initial_min_instance_count">
                        </mat-form-field>
                        <mat-form-field style="width:30%; margin-left: 0.5em">
                          <input matInput placeholder="Maximum" type="number" formControlName="instance_max_count"
                            required>
                        </mat-form-field>
                      </app-metadata-item>
                    </div>
                  </div>
                </form>
                <mat-error
                  *ngIf="editSpecificDateForm.get('instance_min_count').hasError('alertInvalidPolicyMinimumRange')">
                  {{alertInvalidPolicyMinimumRange}}
                </mat-error>
                <mat-error
                  *ngIf="editSpecificDateForm.get('instance_max_count').hasError('alertInvalidPolicyMaximumRange')">
                  {{alertInvalidPolicyMaximumRange}}
                </mat-error>
                <mat-error
                  *ngIf="editSpecificDateForm.get('initial_min_instance_count').hasError('alertInvalidPolicyInitialMaximumRange')">
                  {{alertInvalidPolicyInitialMaximumRange}}
                </mat-error>
                <mat-error
                  *ngIf="editSpecificDateForm.get('start_date_time').hasError('alertInvalidPolicyScheduleStartDateTimeBeforeNow')">
                  {{alertInvalidPolicyScheduleStartDateTimeBeforeNow}}
                </mat-error>
                <mat-error
                  *ngIf="editSpecificDateForm.get('start_date_time').hasError('alertInvalidPolicyScheduleEndDateTimeBeforeStartDateTime')">
                  {{alertInvalidPolicyScheduleEndDateTimeBeforeStartDateTime}}
                </mat-error>
                <mat-error
                  *ngIf="editSpecificDateForm.get('start_date_time').hasError('alertInvalidPolicyScheduleSpecificConflict')">
                  {{alertInvalidPolicyScheduleSpecificConflict}}
                </mat-error>
                <mat-error
                  *ngIf="editSpecificDateForm.get('end_date_time').hasError('alert_invalid_policy_schedule_start_endtime_before_now')">
                  {{alert_invalid_policy_schedule_start_endtime_before_now}}
                </mat-error>
                <mat-error
                  *ngIf="editSpecificDateForm.get('end_date_time').hasError('alertInvalidPolicyScheduleEndDateTimeBeforeStartDateTime')">
                  {{alertInvalidPolicyScheduleEndDateTimeBeforeStartDateTime}}
                </mat-error>
                <mat-error
                  *ngIf="editSpecificDateForm.get('end_date_time').hasError('alertInvalidPolicyScheduleSpecificConflict')">
                  {{alertInvalidPolicyScheduleSpecificConflict}}
                </mat-error>
              </div>
            </mat-card-content>
            <mat-card-actions class="app-auto-scaler__actions">
              <button *ngIf="editIndex!=index" (click)="editSpecificDate()" [disabled]="editIndex!=-1"
                mat-icon-button>
                <mat-icon>edit</mat-icon>
              </button>
              <button *ngIf="editIndex==index" (click)="finishSpecificDate()"
                [disabled]="editSpecificDateForm.invalid" mat-icon-button>
                <mat-icon>done</mat-icon>
              </button>
              <button (click)="removeSpecificDate(index)" mat-icon-button>
                <mat-icon>delete</mat-icon>
              </button>
            </mat-card-actions>
          </mat-card>
        </app-tile>
      </app-tile-group>
    </app-tile-grid>
    <mat-error *ngIf="!submitStatus" style="width: 100%">
      {{submitMessage}}
    </mat-error>
    <div *ngIf="submitStatus" style="width: 100%">
      {{submitMessage}}
    </div>
  </app-step>
</app-steppers>